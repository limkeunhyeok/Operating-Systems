# Operating System

## Charpter 07 가상 기억 장치 관리

### 1. 가상 기억 장치(virtual memory) 기본 개념

- 가상 기억 장치는 프로세스의 전체가 완전히 기억 장치 내에 존재하지 않아도 수행할 수 있는 기법이다.
  - 논리 메모리와 실제 메모리를 분리시킴으로써 주기억 장치의 한계를 걱정할 필요가 없게 한다.
  - 구현하기가 어려우며, 잘못 사용하면 실질적으로 성능이 저하될 수도 있다.
- 가상 기억 장치의 기본 개념은 프로그램, 데이터, 스택의 결합된 크기가 이용할 수 있는 물리적인 기억 장치를 초과한다는 데 있다.
  - 현재 정기적으로 실행되는 프로그램의 일부는 1차 기억 장치(주기억 장치)에 유지하고, 더 이상 빈번하게 사용되지 않는 나머지는 2차 기억 장치(가상 기억 장치, 디스크)에 유지한다.

### 2. 가상 기억 장치 용어 정리

- 2단계 기억 장치 기법
  - 1차 기억 장치: 프로세스가 실행되고, 실행 중인 프로세스로 참조되게 자료를 저장할 주기억 장치를 말한다.
  - 2차 기억 장치: 제한된 주기억 장치에 한번에 저장할 수 없는 프로그램과 데이터를 저장할 수 있는 디스크와 같은 보조 기억 장치 즉 가상 기억 장치라고 한다.

![2단계기억장치](https://user-images.githubusercontent.com/38815618/87171068-30446000-c30d-11ea-9a05-aff95cb55277.PNG)

- 가상 기억 장치: 사용자가 보조 기억 장치의 용량에 해당하는 커다란 기억 장소를 갖고 있는 것처럼 생각하고 프로그램을 작성할 수 있게 하는 개념으로 하드웨어와 소프트웨어의 결합체이다. 이는 다중 프로그램의 등장으로 사용할 수 있는 기억 장치 양의 증대를 꾀할 수 있는 방식이다.
- 가상 주소(virtual address): 수행 중인 프로세스가 참조하는 페이지 주소, 보조 기억 장치 번지를 말한다.
  - 이들 번지의 집합을 가상 주소 공간(virtual address space)이라 한다.
- 실주소(real address) 또는 물리 주소(physical address): 주기억 장치의 사용 가능한 주소를 말한다.
  - 이들 번지의 집합을 실주소 공간(real address space)이라 한다.
- 가상 주소 수의 크기: 가상 주소 G 내의 주소 수는 |G|로 표시하고 실주소 H 내의 주소 수는 |H|로 표시하며, 실제로 구현되는 가상 기억 장치 시스템에서는 |G| > |H|가 된다.
- 가상 주소 변환(VAT, Virtual Address Translation 또는 바인딩) 기법: 가상 주소를 주기억 장소의 실주소로 변환하는 주소 변환 함수 Bt이다.
- 세그먼트(segment), 페이지(page): 운영 체제에서는 프로그램을 블록이라고 하는 작은 조각으로 나누어서 보조 기억 장치와 주기억 장치 사이에서 블록을 교환하면서 프로그램을 수행한다. 이 블록을 같은 크기로 나눈 것이 페이지이고, 이 블록을 다른 크기로 나눈 것이 세그먼트이다.
- 페이징(paging), 세그멘테이션(segmentation): 주기억 장치와 보조 기억 장치 사이에서 세그먼트나 페이지를 교환하면서 프로그램을 수행하려고 가상 주소에서 물리 주소로 런타임에 바인딩하는 기법이다.

### 3. 가상 주소 변환

#### 주소 공간 사상 과정

- 가상 기억 장치 시스템은 이름 공간, 가상 주소 공간, 물리 주소 공간을 구별한다.
  - 심볼 이름에서 가상 주소로, 가상 주소에서 물리 주소로의 사상하는 기법이 제공되며, 이러한 기법이 페이징과 세그멘테이션이다.

![사상과정](https://user-images.githubusercontent.com/38815618/87171072-31758d00-c30d-11ea-81d8-e2a9f8758eb2.PNG)

- 원시 프로그램(source program)은 심볼 식별자(symbol identifier), 레이블(label), 변수(variable)로 구성되며, 이 항목들을 이름 공간이라고 한다.
- 프로그램이 절대 프로그램으로 번역될 때, 이름 공간 내의 각각의 심볼 식별자들은 가상 주소로 변환된다.
- 가상 주소 공간은 절대 적재 모듈에 나타나는 모든 주소를 포함하고 있다.
  - 각각의 가상 주소는 로더나 동적 재배치 하드웨어로 실행할 수 있는 이미지로 번역될 때, 물리 주소로 변환한다.

#### 가상 주소 변환(Virtual Address Translation, VAT) 기법

- VAT는 프로세스가 수행될 때 가상 주소를 실제 주소로 변환하는 기법을 말한다.
  - 이 기법으로 인해 사용자는 프로그램과 데이터가 주기억 장치의 어느 곳에 위치하는 가를 걱정하지 않아도 된다.

![가상과실주소사상](https://user-images.githubusercontent.com/38815618/87171070-30dcf680-c30d-11ea-9263-c0b5321f285a.PNG)

- 가상 주소 공간은 사상 함수(mapping function)으로 물리 주소 공간으로 사상된다.
- 위 그림의 Bt는 시간 t에 가상 주소 공간에서 물리 주소 공간으로의 시간 변화 매핑을 나타낸다.
  - 여기서 t는 음이 아닌 정수로 프로세스의 가상 시간(virtual time)이고 Ω은 null 주소를 참조하는 기호이다.

![Bt개념](https://user-images.githubusercontent.com/38815618/87171069-30dcf680-c30d-11ea-98bb-aefe3f93889c.PNG)

- 가상 주소가 i인 실행할 수 있는 이미지가 주기억 장치로 적재될 때 Bt(i)는 i의 내용이 적재된 물리 주소이고, 적재되지 않았다면 Bt(i) = Ω일 것이다.
  - 적재되지 않았을 때 프로세스나 스레드가 가상 주소 i를 읽거나 쓰려고 시도한다면 페이지 부재(page fault)가 발생하고 가상 기억 장치 관리자는 가상 기억 장치 i의 위치를 주기억 장치로 복사한다.
- 가상 주소 변환 기법을 위해서는 페이지 테이블이나 세그먼트 테이블을 주기억 장치 내에 유지하여야 한다.

#### 인위적인 연속성(artificial continuity)

- 인위적인 연속성이란 모든 프로세스가 가지는 가상 주소 공간상의 연속된 페이지 주소들은 주기억 공간에 배치되면서 페이지 프레임 주소가 반드시 연속적일 필요가 없다는 의미이다.
  - 프로세스가 실행되면서 가상 주소 공간상의 모든 페이지들 중 일부 페이들만 주기억 장치에 적재되고 수시로 교체돼서 주기억 장치의 임의의 페이지 프레임 내에 페이지들이 동적으로 재배치되기 때문이다.

![인위적인연속성](https://user-images.githubusercontent.com/38815618/87171066-2f133300-c30d-11ea-9b4c-30aaff50c6f7.PNG)
