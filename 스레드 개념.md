# Operating System

## Charpter 03 프로세스와 스레드

### 1. 스레드 개요

- 스레드(thread)란 프로세서를 사용하는 기본 단위이며, 명령어를 독립적으로 실행할 수 있는 하나의 제어 흐름이다.
- 스레드는 같은 그룹의 스레드와 코드, 주소 공간, 운영 체제의 자원(파일, 신호) 등을 공유한다.
- 프로세스는 하나 이상의 스레드를 가지고 있다.
- 스레드는 다음과 같은 사항들을 포함하고 있다.
  - 스레드 실행 상태(실행, 준비 등)
  - 실행 스택
  - 수행 중이 아닐 때 저장되어 있는 스레드 문맥
  - 지역 변수 저장을 위해 각 스레드가 사용하는 스레드별 정적 저장소
  - 프로세스의 메모리 및 자원에 대한 접근으로, 메모리 및 자원은 프로세스의 모든 스레드에 의해 공유

### 2. 스레드 디스크립터의 정보

- 하나의 프로세스가 생성될 때 그의 기본 스레드도 생성된다.
- 하나의 프로세스 안의 모든 스레드가 종료하면 프로세스가 제거된다.
- 스레드 관리 알고리즘은 스레드를 생성하고 관리하는 프로세스 관리의 일부이다.
- 스레드를 관리하는 주요 임무는 다음과 같다.
  - 스레드의 생성과 소멸
  - 스레드 특정 자원의 할당
  - 스레드 스케줄링과 문맥 교환 관리
- 스레드 디스크립터(thread descriptor)는 운영 체제가 해당 스레드를 관리하게 필요한 정보를 보관하는 자료 구조로, 하나의 스레드에 사용되는 대부분의 자원은 스레드가 아닌 연관된 프로세스에 할당된다.

|필드|설명|
|---|---|
|상태|기본 스레드의 현재 상태|
|실행 시간 통계|누적 시간, 시작 시간 등 정보|
|프로세스|스레드와 연관된 프로세스의 프로세스 디스크립터 참조|
|관련 스레드 리스트|스레드의 부모/자식/형제 스레드 리스트|
|스택|주기억 장치 내의 기본 스레드의 스택 위치|
|다른 자원|스레드 특정 자원 참조|

### 3. 스레드 종류

![스레드_프로세스_관계](https://user-images.githubusercontent.com/38815618/86214657-661f7100-bbb6-11ea-8948-e85d277140a3.png)

- 하나의 스레드를 갖는 프로세스들은 자신의 프로그램 카운터와 스택, 레지스터들과 주소공간을 가지고 있다.
  - 이들 프로세스는 시스템의 프로세스 간 통신 프리미티브를 통한 통신 외에는 상호 간에 아무 일도 하지 않는다.
- 여러 스레드를 갖는 프로세스에서, 스레드들은 조그마한 미니 프로세스와 같다.
- 대부분의 기본 프로그램들은 하나의 프로세스가 하나의 스레드를 갖는 형태로 구성되어 있다.

![단일다중프로세스](https://user-images.githubusercontent.com/38815618/86214653-64ee4400-bbb6-11ea-8fc9-488890cfcddc.PNG)

- 다중 스레딩(multi threading)이란 다수의 스레들를 이용하여 하나의 프로그램을 동시에 처리하는 것이다.
  - 다중 프로세싱과는 달리, 하나의 프로세스 자체에 다수의 실행 단위들이 존재하여 작업의 수행에 필요한 자원들을 공유하므로 자원의 생성과 관리가 중복되는 것을 최소화할 수 있다.
- 자원 공유는 하나의 프로세스 내에서뿐만 아니라 여러 개의 서로 다른 프로세스들 사이에서도 공유할 수 있다.
- 하나의 프로그램을 다중 스레딩 기법을 이용하여 수행할 때, 각 스레드는 서로 독립적으로 동시에 수행할 수 있어 다중 프로세스 시스템에서는 물론 단일 프로세스 시스템 상에서도 업무의 실질적인 다중 처리를 할 수 있게 된다.

### 4. 스레드 상태

- 스레드는 실행 과정 동안에 상태가 변화한다.
- 각 스레드는 정확한 순차적 실행을 하며, 자신이 어디에 있는지를 유지하려고 자신의 프로그램 카운터와 스택이 있다.
- 한 스레드가 먼저 실행하고 나면 다른 스레드가 시분할 공유하여 실행함으로써, 스레드는 프로세스가 하는 것처럼 CPU를 공유한다.
- 스레드는 자식 스레드를 생성시킬 수 있고 시스템 호출이 완료될 때까지 기다리는 동안 대기 상태에 있을 수 있다.
- 한 스레드가 대기 상태가 되면 같은 프로세스 내에 있는 다른 스레드가 실행될 수 있다.

![스레드_상태변화](https://user-images.githubusercontent.com/38815618/86214656-6586da80-bbb6-11ea-9baf-fb7412985bc4.PNG)

- 대기 상태: 스레드가 다른 스레드나 또는 외부의 사건과 동기화 중에 있는 상태로, 실행에 부적합한 상태이다.
- 준비 상태: 스레드가 프로세서로 실행될 수 있는 상태이다.
- 실행 상태: 스레드가 현재 프로세스를 가지고 실행 중에 있는 활성화된 상태이다.
- 종료 상태: 스레드가 작업 수행을 완전히 종료한 상태이다.

### 5. 스레드 구현

#### 사용자 수준 스레드(ULT, User Level Thread)

- 스레드 관리와 관계된 모든 일은 응용 프로그램이 수행하며, 커널은 스레드의 존재를 알지 못한다.
- 사용자 수준 스레드는 커널 스레드를 지원하지 않은 운영 체제에서 사용하며, 사용자 수준 스레드 여러 개가 커널 스레드 하나로 매핑되는 방식이다.
- 사용자 수준 스레드는 다중 스레드 프로세스에 대해 프로세서(실행 문맥) 하나를 할당하므로 다대일 스레드 매핑이라 한다.

![사용자_수준_스레드](https://user-images.githubusercontent.com/38815618/86214654-6586da80-bbb6-11ea-8498-075d2eb3e6d2.PNG)

- 응용 프로그램은 사용자 수준 스레드 관리를 위한 스레드 라이브러리(스레드 패키지)를 이용하여, 다중 스레드 프로그래밍을 가능하게 하고, 기본적으로 스레드 하나에서 시작, 해당 스레드에서 실행을 시작하다.
- 스레드 라이브러리는 스레드 생성, 종료, 문맥 교환을 위한 코드, 동기화, 메모리 할당, 스레드 간 메시지 전달, 스레드 실행 스케줄링, 스레드 문맥의 저장과 복구 등을 위한 정보를 포함하고 있다.
- 스레드의 생성은 스레드 라이브러리의 생성 유틸리티를 통해 이루어지고, 제어는 프로시저 호출을 통해 해당 유틸리티로 이동하여 수행된다.
- 장점
  - 높은 이식성: 기본 커널 변경 없이 모든 운영 체제에 적용이 가능하다.
  - 오버헤드 감소: 스레드 관리를 위한 모든 데이터 구조가 프로세스의 사용자 주소 공간에 있어, 커널의 도움 없이 스레드 교환이 가능하다.
  - 스케줄링의 유연성: 스레드 라이브러리에서 스레드 스케줄링을 제어하기 때문에 스케줄링이 응용 프로그램에 맞게 적절히 구성된다.
- 단점
  - 시스템의 동시성 지원 불가: 한번에 하나의 스레드만 커널에 접근 가능하기 때문에 여러 스레드가 시스템 호출을 동시에 사용할 수 없다.
  - 시스템 규모 확장 제약: 커널이 프로세서 내부의 다중 스레드를 프로세스 하나로 관리, 다중 처리 환경에서 여러 프로세스를 이용한 분산 처리를 할 수 없다.
  - 스레드 간 보호가 어려움: 스레드 간의 보호에 커널의 보호 기법을 사용할 수 없고, 스레드 라이브러리에서 스레드 간 보호를 제공해야 프로세스 수준에서 보호가 된다.

#### 커널 수준 스레드(KLT, Kernel Level Thread)

- 스레드 관리와 관련된 모든 작업이 커널에 의해서 이루어진다.
- 응용 영역에는 스레드 관리를 위한 정보가 없고 단순히 커널 스레드 기능에 대한 API가 있다.
- 사용자 수준 스레드의 한계를 해결하기 위해 사용자 스레드마다 프로세서(실행 문맥)를 매핑하는 일대일 스레드 매핑을 지원한다.

![커널_수준_스레드](https://user-images.githubusercontent.com/38815618/86214660-661f7100-bbb6-11ea-9e62-a50c142927a8.PNG)

- 커널 수준 스레드는 커널에 의해 생성 및 삭제되고, 커널의 텍스트와 전역 데이터를 공유, 자신만의 커널 스택을 가진다.
- 사용자 영역에는 스레드 관리를 위한 코드가 없고, 모든 응용 프로그램은 다중 스레드로 지원되며 응용 프로그램의 스레드도 모두 하나의 프로세스에서 지원된다.
- 스레드 관련 모든 작업은 커널(운영 체제)이 지원하며, 전체 프로세스에 대한 문맥 정보와 각 프로세스 내 스레드에 대한 문맥 정보를 유지한다.
- 장점
  - 커널에 의한 직접적인 스케줄링과 실행으로 사용자 수준 스레드의 문제를 해결하여 시스템 성능을 향상시킨다.
  - 하나가 시스템 호출 시 다른 스레드가 중단되는 다대일 방식의 문제를 해결할 수 있어 다중 프로세서에서 다중 스레드를 병렬로 실행 가능하다.
- 단점
  - 커널 스레드 생성으로 인한 오버헤드 증가로 응용 프로그램의 성능 저하를 막기 위해 시스템이 지원 스레드 수를 제한해야 한다.
  - 사용자 수준 스레드보다 스케줄링과 동기화를 위해 자원이 더 필요하다.
  - 시스템이 모든 스레드를 관리하므로 오버헤드가 증가한다.
  - 시스템 변경 시 제공된 스레드 API를 사용하여 프로그램을 수정해야 하므로 이식성이 떨어진다.

#### 혼합형 스레드 지원

- 혼합형 스레드는 스레드의 생성을 사용자 영역에서 하고, 여러 개의 사용자 수준 스레드에 여러 개의 커널 스레드가 매핑되는 다대다 스레드 모델이다.
- 스레드 수가 제한되는 커널 수준 스레드의 일대일 방식과 사용자 수준 커널의 다대일 방식에서 제기된 혼합형 스레드는, 시스템 호출 시 다른 스레드가 중단되는 문제를 해결하기 위한 방법이다.

![혼합형_스레드](https://user-images.githubusercontent.com/38815618/86214662-66b80780-bbb6-11ea-869b-ec1924fb5d01.PNG)

![관계표](https://user-images.githubusercontent.com/38815618/86214651-63bd1700-bbb6-11ea-8e72-303cb823a715.PNG)
